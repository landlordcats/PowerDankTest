<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页NFC卡片交互</title>
    <style>
        body { padding: 20px; font-size: 16px; }
        #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; min-height: 200px; white-space: pre-wrap; }
        button { padding: 8px 16px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <button id="startNfc">启动NFC检测</button>
    <div id="log">日志信息：\n</div>

    <script>
        const startBtn = document.getElementById('startNfc');
        const log = document.getElementById('log');
        let ndefReader; // 全局NFC阅读器实例，用于持续监听

        // 日志打印工具
        function printLog(text) {
            log.textContent += `[${new Date().toLocaleTimeString()}] ${text}\n`;
            log.scrollTop = log.scrollHeight; // 自动滚动到底部
        }

        // 检查浏览器是否支持Web NFC API
        function checkNfcSupport() {
            if (!('NDEFReader' in window)) {
                printLog('错误：当前浏览器不支持Web NFC API（仅安卓Chrome/Edge支持）');
                startBtn.disabled = true;
                return false;
            }
            printLog('检测到浏览器支持Web NFC API');
            return true;
        }

        // 核心：NFC初始化、监听、指令发送、回应接收
        async function initNfc() {
            if (!checkNfcSupport()) return;

            try {
                // 1. 创建NDEFReader实例，申请NFC权限（用户需手动允许）
                ndefReader = new NDEFReader();
                printLog('请在弹窗中允许网页访问NFC设备');

                // 2. 监听NFC卡片靠近事件（scan事件：卡片检测/重连触发）
                ndefReader.addEventListener('scan', async (event) => {
                    const tag = event.tag; // 获取NFC卡片标签对象，包含核心信息
                    
                    // 3. 读取NFC卡片唯一ID（tag ID）：Uint8Array格式，转十六进制更易读
                    const tagId = Array.from(tag.id).map(byte => byte.toString(16).padStart(2, '0')).join(':');
                    printLog(`检测到NFC卡片 | 卡片ID：${tagId}`);
                    printLog(`卡片支持的协议：${tag.serialNumber ? 'ISO 14443A/B' : '其他'}`);

                    try {
                        // 4. 向NFC卡片发送自定义指令（核心步骤）
                        // 指令格式：Uint8Array（需遵循你的NFC卡片通信协议，示例为通用测试指令）
                        // 示例：发送「00 A4 04 00 00」（选择空应用，多数NFC卡片支持）
                        const sendCommand = new Uint8Array([0xC2, 0xFF]);
                        printLog(`发送指令（十六进制）：${Array.from(sendCommand).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);

                        // 5. 等待并接收卡片回应（write方法返回回应数据，Uint8Array格式）
                        // write方法：向NFC卡片写入/发送指令，自动等待回应，超时抛错
                        const response = await ndefReader.write(sendCommand, {
                            signal: AbortSignal.timeout(5000) // 5秒超时，避免无限等待
                        });

                        // 6. 解析回应数据（转十六进制，方便查看和业务处理）
                        const responseHex = Array.from(response).map(byte => byte.toString(16).padStart(2, '0')).join(' ');
                        printLog(`卡片回应成功（十六进制）：${responseHex}`);
                        printLog('------------------------NFC交互完成------------------------\n');

                    } catch (sendErr) {
                        printLog(`指令发送/回应接收失败：${sendErr.message}`);
                        printLog('请检查指令格式是否符合卡片协议，或卡片是否支持该指令\n');
                    }
                });

                // 启动NFC监听（需用户授权后执行，仅能由用户交互触发，如点击按钮）
                await ndefReader.scan({
                    keepReading: true // 保持监听，支持多张卡片连续检测，设为false则检测一次后停止
                });
                printLog('NFC监听已启动，请将NFC卡片靠近手机背面\n');

            } catch (initErr) {
                printLog(`NFC初始化失败：${initErr.message}`);
                if (initErr.name === 'NotAllowedError') {
                    printLog('原因：用户拒绝了NFC权限申请，请重新启动并允许权限\n');
                }
            }
        }

        // 绑定按钮点击事件（用户交互触发NFC初始化，浏览器安全限制）
        startBtn.addEventListener('click', initNfc);

        // 页面加载时检查支持性
        window.onload = checkNfcSupport;
    </script>
</body>
</html>