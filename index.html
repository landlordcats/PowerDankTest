<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFCå¡ç‰‡æŒ‡ä»¤é€šä¿¡å·¥å…·</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        /* å®¹å™¨æ ·å¼ */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* æ ‡é¢˜æ ·å¼ */
        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        main {
            padding: 20px;
        }

        /* åŠŸèƒ½åŒºåŸŸ */
        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 18px;
            color: #2c3e50;
            margin: 0;
        }

        .section-content {
            padding: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #27ae60, #219653);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-container {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-icon {
            font-size: 20px;
        }

        .status-text {
            font-size: 16px;
            font-weight: 600;
        }

        .status-details {
            font-size: 14px;
            color: #666;
        }

        /* æ•°æ®å±•ç¤ºåŒº */
        .data-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .data-header {
            color: #3498db;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .data-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.8;
        }

        .hex-byte {
            padding: 2px 6px;
            margin: 0 2px;
            background-color: #34495e;
            border-radius: 3px;
            font-weight: bold;
        }

        .send-byte {
            background-color: #27ae60;
            color: white;
        }

        .receive-byte {
            background-color: #3498db;
            color: white;
        }

        .error-byte {
            background-color: #e74c3c;
            color: white;
        }

        /* æ—¶é—´æˆ³ */
        .timestamp {
            color: #95a5a6;
            font-size: 12px;
            margin-left: 10px;
        }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .steps-container::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }

        .step.active .step-circle {
            background-color: #3498db;
            color: white;
        }

        .step.completed .step-circle {
            background-color: #2ecc71;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #666;
        }

        .step.active .step-label {
            color: #3498db;
            font-weight: 600;
        }

        .step.completed .step-label {
            color: #2ecc71;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ—¥å¿—å®¹å™¨ */
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #95a5a6;
            font-weight: 600;
        }

        .log-type-info {
            color: #3498db;
        }

        .log-type-success {
            color: #2ecc71;
        }

        .log-type-error {
            color: #e74c3c;
        }

        .log-type-warning {
            color: #f39c12;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .steps-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .steps-container::before {
                display: none;
            }
            
            .step {
                display: flex;
                align-items: center;
                gap: 10px;
                text-align: left;
            }
            
            .step-circle {
                margin: 0;
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NFCå¡ç‰‡æŒ‡ä»¤é€šä¿¡å·¥å…·</h1>
            <p class="subtitle">é€šè¿‡Web NFC APIä¸NFCå¡ç‰‡è¿›è¡ŒæŒ‡ä»¤äº¤äº’</p>
        </header>
        
        <main>
            <!-- æ”¯æŒæ£€æµ‹ -->
            <div class="section">
                <div class="section-header">
                    <h2>ç³»ç»Ÿæ£€æµ‹</h2>
                </div>
                <div class="section-content">
                    <div id="support-status" class="status-container">
                        <div class="status-header">
                            <span class="status-icon">ğŸ”</span>
                            <span class="status-text">æ­£åœ¨æ£€æµ‹NFCæ”¯æŒ...</span>
                        </div>
                        <div class="status-details"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œåŒºåŸŸ -->
            <div class="section">
                <div class="section-header">
                    <h2>æŒ‡ä»¤é€šä¿¡</h2>
                    <span id="connection-status" class="status-text">æœªè¿æ¥</span>
                </div>
                <div class="section-content">
                    <div class="button-group">
                        <button id="start-btn" class="btn btn-primary">
                            <span id="start-icon">â–¶ï¸</span>
                            <span>å¼€å§‹æŒ‡ä»¤é€šä¿¡</span>
                        </button>
                        <button id="stop-btn" class="btn btn-warning" disabled>
                            <span>â¹ï¸</span>
                            <span>åœæ­¢é€šä¿¡</span>
                        </button>
                        <button id="clear-btn" class="btn btn-secondary">
                            <span>ğŸ—‘ï¸</span>
                            <span>æ¸…é™¤æ—¥å¿—</span>
                        </button>
                    </div>
                    
                    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                    <div class="steps-container">
                        <div class="step" id="step1">
                            <div class="step-circle">1</div>
                            <div class="step-label">å‘é€æŒ‡ä»¤ 1</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-circle">2</div>
                            <div class="step-label">ç­‰å¾…å“åº”</div>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-circle">3</div>
                            <div class="step-label">å‘é€æŒ‡ä»¤ 2</div>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-circle">4</div>
                            <div class="step-label">ç­‰å¾… 20ms</div>
                        </div>
                        <div class="step" id="step5">
                            <div class="step-circle">5</div>
                            <div class="step-label">å‘é€æŒ‡ä»¤ 3</div>
                        </div>
                        <div class="step" id="step6">
                            <div class="step-circle">6</div>
                            <div class="step-label">å®Œæˆé€šä¿¡</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®å±•ç¤ºåŒº -->
            <div class="section">
                <div class="section-header">
                    <h2>é€šä¿¡æ•°æ®</h2>
                    <span id="card-info">æœªæ£€æµ‹åˆ°å¡ç‰‡</span>
                </div>
                <div class="section-content">
                    <div id="data-display" class="data-container">
                        <div class="data-header">æŒ‡ä»¤é€šä¿¡è®°å½•ï¼š</div>
                        <div class="data-content" id="data-content">
                            ç­‰å¾…å¼€å§‹é€šä¿¡...
                        </div>
                    </div>
                    
                    <!-- è¯¦ç»†æ—¥å¿— -->
                    <div class="section-header">
                        <h3>è¯¦ç»†æ—¥å¿—</h3>
                        <span id="log-count">0 æ¡è®°å½•</span>
                    </div>
                    <div class="log-container" id="log-container">
                        <!-- æ—¥å¿—æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
            
            <!-- æŒ‡ä»¤è¯´æ˜ -->
            <div class="section">
                <div class="section-header">
                    <h2>æŒ‡ä»¤è¯´æ˜</h2>
                </div>
                <div class="section-content">
                    <div style="font-family: monospace; line-height: 1.8;">
                        <div style="margin-bottom: 10px;">
                            <strong>æŒ‡ä»¤åºåˆ—ï¼š</strong>
                        </div>
                        <div style="margin-bottom: 5px; color: #27ae60;">
                            1. å‘é€: <span class="hex-byte send-byte">0xC2</span> <span class="hex-byte send-byte">0xFF</span>
                        </div>
                        <div style="margin-bottom: 5px; color: #3498db;">
                            ç­‰å¾…å¡ç‰‡å“åº”...
                        </div>
                        <div style="margin-bottom: 5px; color: #27ae60;">
                            2. ç­‰å¾… 1ms åå‘é€: <span class="hex-byte send-byte">0x03</span> <span class="hex-byte send-byte">0x00</span> <span class="hex-byte send-byte">0x00</span> <span class="hex-byte send-byte">0x00</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            (æ­¤æŒ‡ä»¤æ— å›åº”)
                        </div>
                        <div style="margin-bottom: 5px; color: #27ae60;">
                            3. ç­‰å¾… 20ms åå‘é€: <span class="hex-byte send-byte">0x30</span> <span class="hex-byte send-byte">0xFC</span>
                        </div>
                        <div style="margin-bottom: 5px; color: #3498db;">
                            ç­‰å¾…å¡ç‰‡å“åº”...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // NFCé€šä¿¡ç®¡ç†å™¨
        class NFCCommunicator {
            constructor() {
                this.nfcReader = null;
                this.isProcessing = false;
                this.currentCard = null;
                this.logEntries = [];
                this.currentStep = 0;
                this.abortController = null;
                
                // æŒ‡ä»¤å®šä¹‰
                this.commands = [
                    { bytes: [0xC2, 0xFF], waitForResponse: true, delayBeforeNext: 1 },
                    { bytes: [0x03, 0x00, 0x00, 0x00], waitForResponse: false, delayBeforeNext: 10 },
                    { bytes: [0x30, 0xFC], waitForResponse: true, delayBeforeNext: 0 }
                ];
                
                this.init();
            }
            
            // åˆå§‹åŒ–
            async init() {
                this.updateSupportStatus('æ­£åœ¨æ£€æµ‹NFCæ”¯æŒ...', 'info');
                
                if (!('NDEFReader' in window)) {
                    this.updateSupportStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web NFC API', 'error');
                    this.updateSupportDetails('è¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome/Edge æµè§ˆå™¨ï¼Œå¹¶ç¡®ä¿åœ¨ HTTPS æˆ– localhost ç¯å¢ƒä¸‹è¿è¡Œ');
                    return;
                }
                
                try {
                    this.nfcReader = new NDEFReader();
                    this.updateSupportStatus('âœ… Web NFC API å¯ç”¨', 'success');
                    this.updateSupportDetails('è®¾å¤‡æ”¯æŒNFCé€šä¿¡ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨');
                    
                    this.bindEvents();
                } catch (error) {
                    this.updateSupportStatus('âŒ NFCåˆå§‹åŒ–å¤±è´¥', 'error');
                    this.updateSupportDetails(error.message || 'æœªçŸ¥é”™è¯¯');
                }
            }
            
            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                document.getElementById('start-btn').addEventListener('click', () => this.startCommunication());
                document.getElementById('stop-btn').addEventListener('click', () => this.stopCommunication());
                document.getElementById('clear-btn').addEventListener('click', () => this.clearLogs());
            }
            
            // å¼€å§‹é€šä¿¡
            async startCommunication() {
                if (this.isProcessing) return;
                
                try {
                    this.isProcessing = true;
                    this.resetSteps();
                    this.updateConnectionStatus('ç­‰å¾…å¡ç‰‡...', 'info');
                    this.addLog('å¼€å§‹æŒ‡ä»¤é€šä¿¡æµç¨‹', 'info');
                    
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    
                    // åˆ›å»ºæ–°çš„AbortController
                    this.abortController = new AbortController();
                    
                    // å¼€å§‹æ‰«æå¡ç‰‡
                    await this.nfcReader.scan({ 
                        signal: this.abortController.signal 
                    });
                    
                    this.nfcReader.onreading = async (event) => {
                        try {
                            const serialNumber = event.serialNumber || 'æœªçŸ¥å¡ç‰‡';
                            this.currentCard = serialNumber;
                            this.updateCardInfo(`å¡ç‰‡: ${serialNumber}`);
                            
                            this.addLog(`æ£€æµ‹åˆ°å¡ç‰‡: ${serialNumber}`, 'success');
                            this.updateConnectionStatus('é€šä¿¡ä¸­...', 'info');
                            
                            // æ‰§è¡ŒæŒ‡ä»¤åºåˆ—
                            await this.executeCommandSequence();
                            
                            this.updateConnectionStatus('é€šä¿¡å®Œæˆ', 'success');
                            this.addLog('æŒ‡ä»¤é€šä¿¡æµç¨‹å®Œæˆ', 'success');
                            
                        } catch (error) {
                            this.handleError('é€šä¿¡è¿‡ç¨‹ä¸­å‡ºé”™', error);
                        } finally {
                            this.stopCommunication();
                        }
                    };
                    
                    this.nfcReader.onreadingerror = (event) => {
                        this.handleError('è¯»å–é”™è¯¯', event.error);
                    };
                    
                } catch (error) {
                    this.handleError('å¯åŠ¨é€šä¿¡å¤±è´¥', error);
                    this.stopCommunication();
                }
            }
            
            // æ‰§è¡ŒæŒ‡ä»¤åºåˆ—
            async executeCommandSequence() {
                for (let i = 0; i < this.commands.length; i++) {
                    this.currentStep = i;
                    this.updateStep(i, 'active');
                    
                    const command = this.commands[i];
                    const stepNumber = i + 1;
                    
                    this.addLog(`æ­¥éª¤ ${stepNumber}: å‘é€æŒ‡ä»¤ ${this.bytesToHex(command.bytes)}`, 'info');
                    this.displayData(`å‘é€æŒ‡ä»¤ ${stepNumber}: ${this.bytesToHex(command.bytes)}`, 'send');
                    
                    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…APIå®ç°æŒ‡ä»¤å‘é€
                    // æ³¨æ„ï¼šWeb NFC APIç›®å‰ä¸»è¦æ”¯æŒNDEFæ ¼å¼ï¼ŒåŸå§‹æŒ‡ä»¤å‘é€å¯èƒ½éœ€è¦ç‰¹å®šå®ç°
                    await this.sendCommand(command.bytes);
                    
                    // ç­‰å¾…å“åº”
                    if (command.waitForResponse) {
                        this.updateStep(i, 'completed');
                        this.currentStep = i + 0.5;
                        this.addLog(`ç­‰å¾…å¡ç‰‡å“åº”...`, 'info');
                        
                        // æ¨¡æ‹Ÿç­‰å¾…å“åº”ï¼ˆå®é™…åº”è¯¥é€šè¿‡äº‹ä»¶ç›‘å¬ï¼‰
                        const response = await this.waitForResponse(1000);
                        
                        if (response) {
                            this.displayData(`æ”¶åˆ°å“åº”: ${this.bytesToHex(response)}`, 'receive');
                            this.addLog(`æ”¶åˆ°å“åº”: ${this.bytesToHex(response)}`, 'success');
                        } else {
                            this.displayData('æœªæ”¶åˆ°å“åº”', 'error');
                            this.addLog('æœªæ”¶åˆ°å“åº”', 'warning');
                        }
                    } else {
                        this.updateStep(i, 'completed');
                        this.addLog(`æŒ‡ä»¤å·²å‘é€ï¼ˆæ— å›åº”ï¼‰`, 'info');
                    }
                    
                    // å»¶è¿Ÿ
                    if (command.delayBeforeNext > 0 && i < this.commands.length - 1) {
                        this.addLog(`ç­‰å¾… ${command.delayBeforeNext}ms...`, 'info');
                        await this.delay(command.delayBeforeNext);
                    }
                }
                
                this.currentStep = this.commands.length;
                this.updateStep(this.commands.length - 1, 'completed');
            }
            
            // å‘é€æŒ‡ä»¤ï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
            // å‘é€æŒ‡ä»¤ï¼ˆå®é™…NFCå®ç°ï¼‰
            async sendCommand(bytes) {
                if (!('NDEFReader' in window)) {
                    this.addLog('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒWeb NFC API', 'error');
                    throw new Error('Web NFC not supported');
                }

                try {
                    this.addLog(`å‡†å¤‡å‘é€: ${this.bytesToHex(bytes)}`, 'info');
                    
                    // åˆ›å»ºNDEFReaderå®ä¾‹
                    const ndef = new NDEFReader();
                    
                    // åˆ›å»ºOpaqueè®°å½•ç±»å‹ï¼Œç”¨äºåŒ…è£…åŸå§‹æŒ‡ä»¤
                    // Opaqueç±»å‹å…è®¸å­˜å‚¨ä»»æ„æ•°æ®
                    const record = {
                        recordType: "mime",
                        data: new Uint8Array(bytes),
                        mediaType: "application/octet-stream"
                    };

                    // å°†è®°å½•å†™å…¥NFCæ ‡ç­¾
                    await ndef.write({
                        records: [record]
                    });
                    
                    this.addLog(`æŒ‡ä»¤å‘é€æˆåŠŸ: ${this.bytesToHex(bytes)}`, 'success');
                    return true;
                    
                } catch (error) {
                    this.addLog(`å‘é€å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }

            // ç­‰å¾…å“åº”ï¼ˆå®é™…NFCå®ç°ï¼‰
            async waitForResponse(timeout = 1000) {
                if (!('NDEFReader' in window)) {
                    throw new Error('Web NFC not supported');
                }

                return new Promise((resolve, reject) => {
                    let timeoutId;
                    const ndef = new NDEFReader();
                    
                    // è®¾ç½®è¶…æ—¶
                    timeoutId = setTimeout(() => {
                        ndef.removeEventListener("reading", handleReading);
                        resolve(null);
                        this.addLog('ç­‰å¾…å“åº”è¶…æ—¶', 'warning');
                    }, timeout);

                    // å¤„ç†è¯»å–äº‹ä»¶
                    const handleReading = ({ message }) => {
                        clearTimeout(timeoutId);
                        ndef.removeEventListener("reading", handleReading);
                        
                        try {
                            // è§£æå“åº”æ•°æ®
                            const record = message.records[0];
                            if (record.recordType === "opaque") {
                                const responseData = Array.from(new Uint8Array(record.data));
                                this.addLog(`æ”¶åˆ°å“åº”: ${this.bytesToHex(responseData)}`, 'success');
                                resolve(responseData);
                            } else {
                                resolve(null);
                            }
                        } catch (error) {
                            resolve(null);
                        }
                    };

                    // å¼€å§‹ç›‘å¬NFCè¯»å–
                    ndef.addEventListener("reading", handleReading);
                    
                    ndef.scan().catch(error => {
                        clearTimeout(timeoutId);
                        reject(error);
                    });
                });
            }
            
            // åœæ­¢é€šä¿¡
            stopCommunication() {
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }
                
                this.isProcessing = false;
                this.currentCard = null;
                
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
                
                this.updateConnectionStatus('å·²åœæ­¢', 'info');
                this.updateCardInfo('æœªæ£€æµ‹åˆ°å¡ç‰‡');
                
                if (this.currentStep < this.commands.length) {
                    this.addLog('é€šä¿¡å·²åœæ­¢', 'warning');
                }
            }
            
            // æ¸…é™¤æ—¥å¿—
            clearLogs() {
                this.logEntries = [];
                this.updateLogDisplay();
                document.getElementById('data-content').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤';
                this.addLog('æ¸…é™¤æ‰€æœ‰æ—¥å¿—', 'info');
            }
            
            // è¾…åŠ©æ–¹æ³•
            bytesToHex(bytes) {
                return bytes.map(b => `0x${b.toString(16).toUpperCase().padStart(2, '0')}`).join(' ');
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            updateStep(stepIndex, state) {
                const stepElement = document.getElementById(`step${stepIndex + 1}`);
                if (stepElement) {
                    stepElement.className = `step ${state}`;
                }
            }
            
            resetSteps() {
                for (let i = 1; i <= 6; i++) {
                    const stepElement = document.getElementById(`step${i}`);
                    stepElement.className = 'step';
                }
                this.currentStep = 0;
            }
            
            // çŠ¶æ€æ›´æ–°æ–¹æ³•
            updateSupportStatus(message, type) {
                const statusElement = document.getElementById('support-status');
                const icon = statusElement.querySelector('.status-icon');
                const text = statusElement.querySelector('.status-text');
                
                icon.textContent = type === 'success' ? 'âœ…' : 
                                 type === 'error' ? 'âŒ' : 'ğŸ”';
                text.textContent = message;
                text.style.color = type === 'success' ? '#27ae60' : 
                                  type === 'error' ? '#e74c3c' : '#3498db';
            }
            
            updateSupportDetails(message) {
                const detailsElement = document.querySelector('#support-status .status-details');
                detailsElement.textContent = message;
            }
            
            updateConnectionStatus(status, type) {
                const element = document.getElementById('connection-status');
                element.textContent = status;
                element.style.color = type === 'success' ? '#27ae60' : 
                                     type === 'error' ? '#e74c3c' : '#3498db';
            }
            
            updateCardInfo(info) {
                document.getElementById('card-info').textContent = info;
            }
            
            displayData(message, type = 'info') {
                const dataContent = document.getElementById('data-content');
                const timestamp = new Date().toLocaleTimeString();
                const typeClass = type === 'send' ? 'send-byte' : 
                                 type === 'receive' ? 'receive-byte' : 'error-byte';
                
                let html = message;
                if (type === 'send' || type === 'receive') {
                    // é«˜äº®æ˜¾ç¤ºåå…­è¿›åˆ¶å­—èŠ‚
                    html = html.replace(/(0x[0-9A-F]+)/g, 
                        `<span class="hex-byte ${typeClass}">$1</span>`);
                }
                
                dataContent.innerHTML += `<div>${html} <span class="timestamp">${timestamp}</span></div>`;
                dataContent.scrollTop = dataContent.scrollHeight;
            }
            
            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    time: timestamp,
                    message: message,
                    type: type
                };
                
                this.logEntries.push(logEntry);
                this.updateLogDisplay();
                
                // æ›´æ–°æ—¥å¿—è®¡æ•°
                document.getElementById('log-count').textContent = `${this.logEntries.length} æ¡è®°å½•`;
            }
            
            updateLogDisplay() {
                const container = document.getElementById('log-container');
                container.innerHTML = '';
                
                this.logEntries.forEach(entry => {
                    const logElement = document.createElement('div');
                    logElement.className = 'log-entry';
                    
                    logElement.innerHTML = `
                        <span class="log-time">[${entry.time}]</span>
                        <span class="log-type-${entry.type}"> ${entry.message}</span>
                    `;
                    
                    container.appendChild(logElement);
                });
                
                container.scrollTop = container.scrollHeight;
            }
            
            handleError(context, error) {
                console.error(`${context}:`, error);
                
                let errorMessage = context;
                if (error.name === 'NotAllowedError') {
                    errorMessage += ': æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸æµè§ˆå™¨è®¿é—®NFC';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += ': è®¾å¤‡ä¸æ”¯æŒæ­¤åŠŸèƒ½';
                } else {
                    errorMessage += `: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
                
                this.addLog(errorMessage, 'error');
                this.displayData(`é”™è¯¯: ${errorMessage}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–NFCé€šä¿¡å™¨
            window.nfcCommunicator = new NFCCommunicator();
            
            // æ·»åŠ ä¸€äº›åˆå§‹æ—¥å¿—
            setTimeout(() => {
                window.nfcCommunicator.addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
                window.nfcCommunicator.addLog('ç‚¹å‡»"å¼€å§‹æŒ‡ä»¤é€šä¿¡"æŒ‰é’®å¼€å§‹æµç¨‹', 'info');
            }, 1000);
        });
    </script>
</body>
</html>